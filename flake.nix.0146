{
  description = "Ambiente di test per l'applicativo Spring/Angular";

  inputs = {
    #
    # --- MODIFICA CHIAVE QUI ---
    # Invece di "nixos-unstable", usiamo un commit specifico
    # (di fine Ottobre 2024) dove php82.mysqli esiste.
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-24.05";
    #
    #
    nixpkgs-old.url = "github:NixOS/nixpkgs/nixos-23.05";
  };

  outputs = { self, nixpkgs, nixpkgs-old, ... }:
    let
      system = "x86_64-linux";
      pkgs = nixpkgs.legacyPackages.${system};
      pkgs-old = import nixpkgs-old {
        inherit system;
        config.permittedInsecurePackages = [ "openssl-1.1.1w" ];
      };

      # --- DEFINIZIONE PHP CON ESTENSIONI ---
      # Ora 'pkgs' è aggiornato, quindi 'ep.mysqli' verrà trovato.
      php82 = pkgs.php82.withExtensions (ep: [
        ep.mysqli 
        ep.curl
        ep.mbstring
      ]);

    in
    {
      devShells.${system}.default = pkgs.mkShell {
        buildInputs = [
          # --- App Stack ---
          pkgs.jdk21
          pkgs.maven
          pkgs.nodejs_24

          # --- Web Admin Stack ---
          pkgs.apacheHttpd
          php82                # Il nostro PHP custom
          pkgs.php82Packages.php-fpm
          pkgs.phpmyadmin

          # --- Management Stack ---
          pkgs.foreman
          pkgs-old.mariadb_104
        ];
      };
    };
}
